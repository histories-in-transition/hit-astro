---
import PageLayout from "@/layouts/page-layout.astro";
import NavLink from "@/components/nav-link.astro";
import Article from "@/components/article.astro";
import DescriptionList from "@/components/ui/DescriptionList.astro";
import DescriptionListItem from "@/components/ui/DescriptionListItem.astro";
import TabulatorTable from "@/components/tabulator-table.svelte";
import { msItemsStratumTableConfig } from "@/lib/tabulator-table-configs.js";

import stratajson from "@/content/data/strata.json";
import type { Stratum } from "@/types";

export async function getStaticPaths() {
	const strata = Object.values(stratajson);
	const paths = strata.map((stratum) => {
		const stratumId = stratum.hit_id;
		return {
			params: { id: stratumId },
			props: { data: stratum as Stratum },
		};
	});
	return paths;
}
const { data: stratum } = Astro.props;

const tableData = msItemsStratumTableConfig.transformData(stratum.msitems);
const columns = msItemsStratumTableConfig.getColumns();
const rowClickConfig = msItemsStratumTableConfig.getRowClickConfig;
---

<PageLayout title={stratum?.label}>
	<Article
		prevLink={`/strata/${stratum.prev.id}`}
		nextLink={`/strata/${stratum.next.id}`}
		mainTitle={stratum.label}
		authorEntry={stratum.manuscript[0].author_entry}
	>
		<div
			class="border-2 rounded-sm border-brandBrown bg-brand-100
			text-sm md:leading-7 md:text-base"
		>
			<section class="m-5 overflow-x-auto" aria-labelledby="workInfo">
				<h2 id="workInfo" class="text-xl font-semibold text-brand-800 mb-5">
					Allgemeine Info zum Stratum:
				</h2>
				<DescriptionList>
					<DescriptionListItem label="Handschrift:">
						<NavLink href=`/manuscripts/hit_manuscript__${stratum.manuscript[0]?.id}`>
							{stratum.manuscript[0]?.library[0].value}, {stratum.manuscript[0]?.value}
						</NavLink>
					</DescriptionListItem>
					<DescriptionListItem label="Datierung:">
						{stratum.date.length > 0 ? stratum.date.map((d) => d.value).join(" | ") : "N/A"}
					</DescriptionListItem>
					<DescriptionListItem label="Ort:">
						{stratum.place.length > 0 ? stratum.place.map((pl) => pl.value).join(" | ") : "N/A"}
					</DescriptionListItem>
					<DescriptionListItem label="Charakter:">
						{stratum.character.join("; ")}
					</DescriptionListItem>
					<DescriptionListItem label="Beschreibung:">
						{stratum.note}
					</DescriptionListItem>

					{
						stratum.stratum_filiations && stratum.stratum_filiations.length > 0 ? (
							<DescriptionListItem label="Filiationen">
								<ul class="list-disc pl-5">
									{stratum.stratum_filiations.map((filiation) => (
										<li>
											{filiation.filiated_strata.map((str, strIndex) => (
												<span>
													{str.internal ? (
														<NavLink href={`/strata/${str.hit_id}`}>{str.value}</NavLink>
													) : str.catalog_url ? (
														<NavLink href={str.catalog_url}>{str.value}</NavLink>
													) : (
														str.value
													)}
													{str.locus && ` (fols. ${str.locus})`}
													{str.note && ` - ${str.note}`}
													{strIndex < filiation.filiated_strata.length - 1 && ", "}
												</span>
											))}
											{filiation.reason && ` - ${filiation.reason}`}
											{filiation.note && ` - ${filiation.note}`}
										</li>
									))}
								</ul>
							</DescriptionListItem>
						) : null
					}
				</DescriptionList>
			</section>

			<!-- /* Table for displaying information about the msitems and hand_roles defining the stratum */ -->

			<section class="m-5 overflow-x-auto" aria-labelledby="workInfo">
				<h2 id="workInfo" class="text-xl font-semibold text-brand-800 mb-5">Stratums Inhalt:</h2>
				<div class="text-sm md:text-base">
					<div id={`${stratum.label}-table`}></div>
				</div>
				<TabulatorTable
					client:only="svelte"
					data={tableData}
					columns={columns}
					tableId={`${stratum.label}-table`}
					downloadTitle={`${stratum.label}-table`}
					rowClickConfig={rowClickConfig}
					updateMapOnFilter={true}
					mapIdField="hit_id"
				/>
			</section>
		</div>
	</Article>

	<script src="@/lib/table-search.js"></script>
</PageLayout>
